## SM3密码算法（改）

​	本文档作用为记录sm3.h修改过程

#### problem1 野指针

问题描述：当主函数不注释掉```printf("%d\n",messagelen);```语句时，使用Dev进行编译运行时，返回错误结果，但注释掉的话程序无法返回结果，并得到了3221225477的返回值。经查阅，这个返回值表示程序中有野指针。（如果用vscode调试的话过不了编译，会直接报错）

printf语句的影响现在仍无法解决，但野指针是可以找到的。在源代码232行的```sm3_context* ctx;```只定义了一个sm3\_context类型的指针，但没有赋初值（初始化）。此时指针指向内存中一片不允许被使用的空间，即野指针。

改：```sm3_context* ctx = new sm3_context;```

#### problem2 消息初始化

问题描述：解决野指针后编译运行，每次结果都不一样。

经检查，主函数中定义的char类型数组message没有进行初始化赋0，所以每次消息块中都有脏消息。解决这个问题后至少每次输出都一样了，即便还是错的。

改：```memset(message, 0, 1000);```

#### problem3压缩函数CF

问题描述：每次执行的时候把ABCDEFGH的值打印出来，发现一些问题

这问题纯傻逼，一个是把H写成D，一个是j从1开始，对着书敲都能敲错了，不说了。

#### problem4消息长的变量

问题描述：第221行左右

```ctx->buffer[56 + i] = (ctx->total >> ((8 - 1 - i) * 8)) & 0xFF;```

total变量记录的是总长度，需要包含在最后一个消息块中，长度为64B，因此用只能存储4个字节32位的unsigned int是不行的，需要换成unsigned long long。

#### problem5输出格式化问题

据说直接printf(‘’%x‘’)会出现长度不一的问题，要用%02x，但我用vscode也没发现，以后再试试。

# 懒得写了，考研要紧。暂时记这么多，代码的调试过程以后再回来填坑。修改后代码是sm3_2.cpp。

打印每轮buffer，加断点看变量值，